---
title: 操作系统-计算机系统概述
date: 2025-07-06 14:49:21
categories:
    - 408
    - 操作系统
---

**22.20** 预处理->编译->汇编->链接

## 中断
### 开中断/关中断
开中断”指的是允许CPU响应来自硬件设备的中断信号，关中断则相反，避免原子操作被打断

### 中断向量表
索引+中断服务程序(ISR)的入口地址

### 中断控制器
中断控制器是一个硬件芯片，统一处理外设的中断请求，避免外设太多引起的混乱。作用有

- 汇总请求
- 优先级仲裁
- 中断屏蔽，操作系统可以通过编程让中断控制器屏蔽某些中断
- 向量化中断，提供中断号，方便CPU去查中断向量表

[22.21] 下列关于硬件和异常/中断关系的叙述中，错误的是( )。
A. CPU 在执行一条指令过程中检测异常事件
B. CPU 在执行完一条指令时检测中断请求信号
C. 开中断中 CPU 检测到中断请求后就进行中断响应
D. 外部设备通过中断控制器向 CPU 发中断结束信号

外设给CPU发送中断请求信号，CPU响应后直接返回保存的现场，不需要外设发送中断结束信号

[22.31] 执行系统调用的过程涉及下列操作，其中由操作系统完成的是( )。
I. 保存断点和程序状态字
II. 保存通用寄存器的内容
III. 执行系统调用服务例程
IV. 将 CPU 模式改为内核态

首先，我们需要理解执行一个系统调用的完整流程。它是一个从“用户态”到“内核态”再返回“用户态”的受控转换过程，由**用户程序、CPU硬件、操作系统软件**三方协同完成。
**流程分解：**

1.  **用户程序准备**：用户程序（例如，通过调用C库函数`printf`，其底层会调用`write`系统调用）将系统调用号和参数放入指定的寄存器或压入栈中。
2.  **执行陷入指令**：用户程序执行一条特殊的机器指令，如 `TRAP` 或 `SYSCALL`。这条指令是整个过程的“扳机”。
3.  **CPU硬件响应（关键步骤）**：当CPU执行到这条陷入指令时，**硬件**会自动地、原子性地完成以下一系列操作：
    * **IV. 将CPU模式改为内核态**：硬件会立即改变处理器状态字（PSW）中的一个标志位，使CPU从用户态切换到**内核态**。这是为了保证接下来执行的代码拥有足够的权限。
    * **I. 保存断点和程序状态字**：硬件需要记下当前程序的执行位置（程序计数器PC，即“断点”）和当前的状态（程序状态字PSW），以便系统调用结束后能准确返回。硬件会自动将这些关键信息压入内核栈。
    * **跳转到处理程序**：硬件根据陷入指令的类型，从一个预设的“中断/陷入向量表”中找到操作系统处理程序的入口地址，并跳转到该地址执行。
4.  **操作系统软件接管**：现在，CPU已经处于内核态，并且开始执行操作系统的代码（即系统调用总入口程序）。
    * **II. 保存通用寄存器的内容**：硬件只保存了最关键的PC和PSW。为了保证系统调用服务例程可以自由使用寄存器而不破坏用户进程的上下文，操作系统代码**首先需要负责保存**所有通用寄存器（如EAX, EBX等）的内容，通常也是压入内核栈。
    * **III. 执行系统调用服务例程**：操作系统根据用户程序传递的系统调用号，去调用内核中对应的具体服务函数（例如，处理文件读写的`sys_write`函数）。这是系统调用的核心工作部分。
5.  **操作系统软件返回准备**：服务例程执行完毕后，操作系统代码会恢复通用寄存器的内容，并将返回值放入指定寄存器。
6.  **执行返回指令**：操作系统执行一条特殊的“中断返回”指令，如 `IRET`。
7.  **CPU硬件返回**：硬件响应`IRET`指令，原子性地从内核栈中弹出之前保存的PC和PSW，恢复它们，这个过程会自动将CPU模式从内核态切回用户态。用户程序从之前断点处的下一条指令继续执行。

### 结论分析

根据上述流程，我们来判断每个操作的执行者：

* **I. 保存断点和程序状态字**：这是由 **CPU硬件** 在响应陷入指令时自动完成的。操作系统软件此时还未开始执行。
* **II. 保存通用寄存器的内容**：这是由 **操作系统** 内核代码在接管控制权后，执行具体服务例ethan前的准备工作。硬件不负责保存这些通用寄存器。
* **III. 执行系统调用服务例程**：这毫无疑问是 **操作系统** 的核心职责。服务例程本身就是构成操作系统的内核代码的一部分。
* **IV. 将 CPU 模式改为内核态**：这是由 **CPU硬件** 在响应陷入指令时，通过修改状态寄存器自动完成的。这是进入内核的“门”，必须由硬件控制以保证安全。

因此，由**操作系统**完成的操作是 **II 和 III**。